/**
 * Guitareo Video Downloader Bookmarklet
 * 
 * This is a minified version of the downloader script that can be used as a bookmarklet.
 * To use it:
 * 1. Create a new bookmark in your browser
 * 2. Give it a name like "Guitareo Downloader"
 * 3. Copy the code below as the URL/location
 * 4. When on a Guitareo page, click the bookmark to activate the downloader
 */

javascript:(function(){
  if(window.GuitareoDownloader){
    alert("Guitareo Downloader is already loaded!");
    console.log("[GuitareoDownloader] Already loaded. Use GuitareoDownloader.help() for commands.");
    return;
  }
  
  var script=document.createElement("script");
  script.type="text/javascript";
  script.src="https://raw.githubusercontent.com/nimishchaudhari/guitareo-downloader/main/guitareo-downloader.js";
  script.onload=function(){
    console.log("[GuitareoDownloader] Script loaded successfully!");
  };
  script.onerror=function(){
    console.error("[GuitareoDownloader] Error loading from GitHub. Using inline version...");
    
    var inlineScript=document.createElement("script");
    inlineScript.textContent=`/**
 * Guitareo Video Downloader - Inline Version
 * A utility to help download videos from Guitareo Method sections.
 */
(function(){window.GuitareoDownloader={lessons:[],downloaded:[],debug:!1,log:function(e,t){this.debug&&(t?console.log("[GuitareoDownloader] "+e,t):console.log("[GuitareoDownloader] "+e))},setDebugMode:function(e){this.debug=!!e,console.log("[GuitareoDownloader] Debug mode "+(this.debug?"enabled":"disabled"))},getVimeoId:function(){const e=/vimeo.+?(\\d{6,})/g;let t,o=[];const n=document.documentElement.innerHTML;for(;null!==(t=e.exec(n));)o.push(t[1]);return this.log("Vimeo IDs found:",o),o.length>0?o[0]:null},getLessonTitle:function(){const e=["h1","h2","h3",".title","[class*=\\"title\\"]","[class*=\\"heading\\"]","[class*=\\"lesson-name\\"]"];for(const t of e){const e=document.querySelector(t);if(e&&e.textContent?.trim())return this.log("Found title in element "+t+":",e.textContent.trim()),e.textContent.trim()}const t=window.location.pathname.split("/"),o=t[t.length-1];return o&&"333652"!==o?(this.log("Extracted title from URL:",o.replace(/-/g," ")),o.replace(/-/g," ")):(this.log("No title found, using default"),"Unknown Lesson")},createSafeFilename:function(e){return e.trim().replace(/[^a-z0-9]/gi,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").toLowerCase()+".mp4"},downloadCurrentVideo:function(e){const t=document.querySelector("video");if(!t||!t.currentSrc)return console.error("[GuitareoDownloader] No video element with source found"),!1;const o=this.getLessonTitle(),n=e||this.createSafeFilename(o);try{const e=document.createElement("a");return e.href=t.currentSrc,e.download=n,e.style.display="none",document.body.appendChild(e),e.click(),setTimeout(()=>{document.body.removeChild(e)},100),this.downloaded.push({title:o,url:t.currentSrc,filename:n,date:(new Date).toISOString()}),console.log('[GuitareoDownloader] Started download of "'+n+'"'),!0}catch(e){return console.error("[GuitareoDownloader] Error downloading video:",e),!1}},findLessonLinks:function(){if(this.lessons=[],const e=document.querySelectorAll("svg"),console.log("[GuitareoDownloader] Examining "+e.length+" SVG elements for lesson cards..."),!window.location.href.includes("/method/"))return console.warn("[GuitareoDownloader] Not on a method page. Please navigate to the Guitareo Method page first."),this.lessons;e.forEach((e,t)=>{let o=e.parentElement;for(let e=0;e<5&&o;e++){let e="",t=o.querySelectorAll("h1, h2, h3, h4, h5, .title, [class*=\\"title\\"]");if(t.length>0)e=t[0].textContent.trim();else if(o.textContent){const t=o.textContent.trim();t.length<100&&(e=t)}if(e&&!this.lessons.some(t=>t.title===e)){this.log('Found lesson card: "'+e+'"'),this.lessons.push({element:o,title:e,index:this.lessons.length+1,visited:!1,downloaded:!1});break}o=o.parentElement}}),this.lessons.sort((e,t)=>{const o=e.element.getBoundingClientRect(),n=t.element.getBoundingClientRect();return o.top-n.top}),this.lessons.forEach((e,t)=>{e.index=t+1}),console.log("[GuitareoDownloader] Found "+this.lessons.length+" lesson cards"),this.lessons.length>0&&(console.log("[GuitareoDownloader] Lessons found:"),this.lessons.forEach(e=>{console.log("  "+e.index+". "+e.title)})),this.lessons},navigateToLesson:function(e){if(0===this.lessons.length)return console.error("[GuitareoDownloader] No lessons found. Run findLessonLinks() first."),!1;const t=this.lessons.find(t=>t.index===e);if(!t)return console.error("[GuitareoDownloader] Lesson with index "+e+" not found."),!1;t.visited=!0;try{return console.log('[GuitareoDownloader] Navigating to lesson '+e+': "'+t.title+'"'),t.element.click(),!0}catch(t){return console.error("[GuitareoDownloader] Error navigating to lesson "+e+":",t),!1}},navigateToNextLesson:function(){if(0===this.lessons.length)return console.error("[GuitareoDownloader] No lessons found. Run findLessonLinks() first."),!1;const e=this.lessons.find(e=>!e.visited);return!!e&&this.navigateToLesson(e.index)},downloadWithVimeoId:async function(e,t){if(!e)return console.error("[GuitareoDownloader] No Vimeo ID provided"),!1;console.log("[GuitareoDownloader] Fetching video info for Vimeo ID: "+e);try{const o=await fetch("https://player.vimeo.com/video/"+e+"/config");if(!o.ok)throw new Error("HTTP error! Status: "+o.status);const n=await o.json(),s=n.request.files.progressive;if(!s||0===s.length)throw new Error("No progressive download files found in Vimeo response");const r=s.sort((e,t)=>t.width-e.width)[0];if(!r||!r.url)throw new Error("Could not find a downloadable video URL");this.log("Found highest quality video:",r);const i=t||"guitareo-vimeo-"+e+".mp4",l=document.createElement("a");return l.href=r.url,l.download=i,l.style.display="none",document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l)},100),this.downloaded.push({vimeoId:e,url:r.url,filename:i,quality:r.width+"x"+r.height,date:(new Date).toISOString()}),console.log('[GuitareoDownloader] Started download of "'+i+'" ('+r.width+"x"+r.height+")"),!0}catch(t){return console.error("[GuitareoDownloader] Error downloading video with ID "+e+":",t),!1}},goToMethodPage:function(){try{return console.log("[GuitareoDownloader] Navigating back to method page..."),window.location.href="https://www.musora.com/guitareo/method/guitareo-method/333652",!0}catch(e){return console.error("[GuitareoDownloader] Error navigating to method page:",e),!1}},showStats:function(){const e={totalLessons:this.lessons.length,visitedLessons:this.lessons.filter(e=>e.visited).length,downloadedVideos:this.downloaded.length,remainingLessons:this.lessons.filter(e=>!e.visited).length};if(console.log("[GuitareoDownloader] Download Statistics:"),console.log("  Total lessons found: "+e.totalLessons),console.log("  Lessons visited: "+e.visitedLessons),console.log("  Videos downloaded: "+e.downloadedVideos),console.log("  Remaining lessons: "+e.remainingLessons),e.downloadedVideos>0){console.log("[GuitareoDownloader] Downloaded videos:");this.downloaded.forEach((e,t)=>{console.log("  "+(t+1)+". "+e.filename)})}return e},reset:function(){this.lessons.forEach(e=>{e.visited=!1,e.downloaded=!1}),this.downloaded=[],console.log("[GuitareoDownloader] Downloader has been reset")},help:function(){console.log("\n===============================\nGUITAREO VIDEO DOWNLOADER HELP\n===============================\n\nAvailable methods:\n\n1. findLessonLinks()\n   Scans the current page for lesson cards and stores them\n\n2. downloadCurrentVideo([customFilename])\n   Downloads the video currently playing on the page\n\n3. navigateToNextLesson()\n   Navigates to the next unvisited lesson\n\n4. navigateToLesson(index)\n   Navigates to a specific lesson by its index\n\n5. downloadWithVimeoId(vimeoId, [customFilename])\n   Downloads a video using its Vimeo ID directly\n\n6. goToMethodPage()\n   Navigates back to the main method page\n\n7. showStats()\n   Shows statistics about found lessons and downloads\n\n8. reset()\n   Resets the state of the downloader\n\n9. setDebugMode(enabled)\n   Enables or disables debug logging\n\n10. help()\n    Shows this help message\n\nWORKFLOW FOR DOWNLOADING ALL VIDEOS:\n1. Navigate to: https://www.musora.com/guitareo/method/guitareo-method/333652\n2. Run: GuitareoDownloader.findLessonLinks()\n3. For each lesson:\n   a. Run: GuitareoDownloader.navigateToNextLesson()\n   b. Wait for the video to load\n   c. Run: GuitareoDownloader.downloadCurrentVideo()\n   d. Run: GuitareoDownloader.goToMethodPage()\n   e. Repeat until all lessons are visited\n")}},console.log("\n===============================\nGUITAREO VIDEO DOWNLOADER\n===============================\n\nThe GuitareoDownloader has been set up! Run GuitareoDownloader.help() to see available commands.\n\nQuick start:\n1. Make sure you're on the Guitareo Method page\n2. Run: GuitareoDownloader.findLessonLinks()\n3. Run: GuitareoDownloader.navigateToNextLesson()\n4. Once the video loads, run: GuitareoDownloader.downloadCurrentVideo()\n5. Run: GuitareoDownloader.goToMethodPage()\n6. Repeat steps 3-5 for each lesson\n"),window.location.href.includes("/method/")?console.log("[GuitareoDownloader] Method page detected. Run findLessonLinks() to begin."):document.querySelector("video")&&console.log("[GuitareoDownloader] Video detected on this page. Run downloadCurrentVideo() to download it.")})();`;
    document.body.appendChild(inlineScript);
    console.log("[GuitareoDownloader] Loaded inline version successfully!");
  };
  document.body.appendChild(script);
})();
